# Editing System

Editing System is a part of [Autonomous Video Artist](https://github.com/bengrosser/autonomous-video-artist). It is a modularized backend server system responsible for creating records based upon videos shot by the robot in the editing database
and editing videos based upon the Deep Analysis that are also done in the Editing System.

### Dependency
Editing System has the following required dependencies:

* [Python](https://www.python.org/) v2.7
* [OpenCV](https://opencv.org/opencv-3-4-1.html) v3.4.1 or higher
* [NumPy](http://www.numpy.org/index.html) v1.14.2 or higher
* [Numba](https://numba.pydata.org/) v0.37.0 or higher
* [RabbitMQ](https://www.rabbitmq.com/#getstarted) v3.6.1 or higher
* [Kombu](https://pypi.org/project/kombu/) v3.0.35 or higher
* [librabbitmq](https://pypi.org/project/librabbitmq/) v1.6.1 or higher
* [matplotlib](https://matplotlib.org/) v2.2.x (For Python 2.7)
* [cairo](http://brewformulas.org/Cairo) Using Homebrew to install Cairo
* [pycairo](https://pypi.org/project/pycairo/) Python Wrapper for Cairo

### Modules

#### Initializer

Initializer sets the macro parameters of the Editing System. In the current version, the parameter that should be specified before running is __enough_quantity__ in the function __initialize_publish__. This parameter specifies how many videos in the database are needed for the editing worker to start edit videos. Since initializer will send important parameters to the whole system, it is important to run initializer at the end so that all the other modules will receive parameters needed.

To run initializer:
```
python initializer.py
```

#### File Watcher

File Watcher monitors the incoming video and JSON files. Every time there are incoming new video files, it will first register corresponding metatdata from their JSON files into the database. After that, it will send the message __data-file-ready__ with the newly added videos' names as the payload to the central exchange. After it received enough number of videos specified in initializer, it will send the message __data-start-enough__ to the central exchange.

To run File Watcher:
```
python filewatcher.py
```

#### Metadata Worker:
Metadata Worker monitors the channel __data-file-ready__. Every time it receives the message from the file_watcher, it will unpack the payload and extract the newly added videos' names. Then it will calculate _metadata_score_ and _to_edit_ (editing ranges based upon each frame's entropy value from the video) for each of the newly added video and insert calculated values to their corresponding record in the database.

To run Metadata Worker:
```
python metadata_worker.py
```

#### Deep Analysis Video Worker:
Deep Analysis Video Worker monitors the channel __data-file-ready__. Every time it receives the message from the file_watcher, it will unpack the payload and extract the newly added videos' names. Then it will start to produce _Wave_, _Gradient_ and _Ellipse_ Deep Analysis videos. Generated Deep Analysis video results will be stored in _da_video_result_ folder.

To run Deep Analysis Video Worker:
```
python da_worker.py
```

#### Editing Worker:
Editing Worker monitors the channel __data-start-enough__. After it received the message, it will extract a certain amount of videos from the database based upon their _metadata_scores_ and start to edit based upon them. For each of the generated video from the Editing Worker, a corresponding _ff_memory_ data blob will also be generated by the Editing Worker. A _ff_memory_ stores a complete collection of values used by the Editing Worker to generate the video, that is to say an edited video can always be fully recovered from its corresponding _ff_memory_. The Editing Worker will also store the _ff_memory_ into the database. For the current version, the dynamic editing parameters passing between different modules functionality has not been developed yet, therefore please make sure to set __self.num_videos_to_use__ in Editing Worker to be equal with __enough_quantity__ in Initializer. The generated videos from Editing Worker will be stored in editing_result folder.

To run Editing Worker:
```
python editing_worker.py
```
